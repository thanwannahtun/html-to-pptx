<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Myanmar ID Card Generator (With Profiles)</title>
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Padauk', sans-serif;
            background-color: #555;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 210mm;
            box-sizing: border-box;
        }

        .input-group {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .btn-group {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        button {
            background-color: #d24726;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            background-color: #b03a1e;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        input[type="file"] {
            margin-bottom: 5px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        /* A4 Page Container */
        .page {
            width: 210mm;
            min-height: 297mm;
            background-color: white;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: 74.25mm;
            padding: 2mm;
            grid-gap: 2mm;
            box-sizing: border-box;
            background-size: 100% auto;
            background-repeat: repeat-y;
        }

        .card {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* --- LAYOUT ELEMENTS --- */

        /* 1. Profile Photo Area */
        .photo-box {
            position: absolute;
            top: 26%;
            left: 7%;
            width: 24%;
            /* Approx width of white box */
            height: 36%;
            /* Approx height */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            /* background: rgba(255,0,0,0.2); Debugging */
        }

        .photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Ensures image covers box without stretching */
        }

        /* 2. Barcode Area */
        .barcode-box {
            position: absolute;
            top: 29.5%;
            width: 35%;
            text-align: center;
        }

        .barcode-box canvas {
            width: 90%;
            height: auto;
        }

        /* 3. Text Info Area */
        .info-box {
            position: absolute;
            top: 65%;
            left: 5%;
            width: 90%;
            font-size: 16px;
            font-weight: bold;
            line-height: 1.9;
            color: #000;
        }

        /* Column Specific Adjustments */
        .card:nth-child(odd) .barcode-box {
            left: 34%;
            top: 29.5%;
        }

        .card:nth-child(even) .barcode-box {
            left: 30.5%;
            top: 29.5%;
        }

        .card:nth-child(even) .info-box {
            left: 1%;
        }

        /* Adjust even card photo if background isn't symmetrical */
        .card:nth-child(even) .photo-box {
            left: 3%;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
        }

        .label {
            width: 38%;
            color: #2e2e2e;
        }

        .val {
            width: 62%;
            padding-left: 5px;
        }
    </style>
</head>

<body>

    <div class="controls">

        <div class="input-group">
            <label>1. Load Excel Data</label>
            <input type="file" id="excelInput" accept=".xlsx, .xls" onchange="loadExcel(event)" />
            <span id="excelStatus"
                style="font-family: sans-serif; font-size: 14px; margin-left: 10px; color: green;"></span>
        </div>

        <div class="input-group">
            <label>2.Pick Background Template</label>
            <input type="file" id="bgInput" accept="image/*" onchange="loadBackground(event)">
        </div>

        <div class="input-group">
            <label>3.Load Profiles Folder</label>
            <p style="font-size: 12px; color: #666; margin:0;">(Select the folder containing images named like
                "A-03484.jpg")</p>
            <input type="file" id="folderInput" webkitdirectory multiple onchange="loadProfileFolder(event)">
            <span id="folderStatus" style="color: green; font-weight: bold;"></span>
        </div>

        <div class="btn-group">
            <h3>Export:</h3>
            <button id="dlBtn" onclick="generatePPTXOptimized()" disabled>Download as .pptx</button>
        </div>
    </div>

    <div class="page" id="card-container">
    </div>

    <script>
        let backgroundBase64 = null;
        let profileMap = {}; // Stores "A-03484" -> "data:image/jpg;base64..."
        // response data list for corresponding card-types ( "A" , "B" , "G" , "M" )
        let databaseData = []

        // 1. Load Background
        function loadBackground(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    backgroundBase64 = e.target.result;
                    document.getElementById('card-container').style.backgroundImage = `url('${backgroundBase64}')`;
                    checkReady();
                };
                reader.readAsDataURL(file);
            }
        }

        // 2. Load Profile Images from Folder
        function loadProfileFolder(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            let loadedCount = 0;
            document.getElementById('folderStatus').innerText = `Loading ${files.length} images...`;

            Array.from(files).forEach(file => {
                // Only process images
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    // Get filename without extension (e.g., "A-03484.jpg" -> "A-03484")
                    // We also handle spaces: "A - 03484" -> "A-03484" to match strict logic if needed
                    // But for now, we assume filenames match CardNo exactly or roughly.

                    // Simple filename cleanup
                    const fileName = file.name.split('.').slice(0, -1).join('.');

                    // Store in map
                    profileMap[fileName] = e.target.result;

                    loadedCount++;
                    if (loadedCount >= files.length - 1) { // Approximate completion
                        document.getElementById('folderStatus').innerText = `Loaded ${Object.keys(profileMap).length} profiles.`;
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function checkReady() {
            if (backgroundBase64) {
                document.getElementById('dlBtn').disabled = false;
            }
        }

        function loadExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Filter out empty rows and the header row
                databaseData = rows.slice(1).filter(row => row.length > 0 && row[1] !== "á€€á€á€ºá€¡á€™á€¾á€á€º").map(row => {
                    // Correct Mapping based on your Image:
                    // row[0]=á€…á€‰á€º, row[1]=CardNo, row[2]=Name, row[3]=NRC, row[4]=Phone, row[5]=Exp
                    const cardValue = String(row[1] || "").trim();

                    return {
                        memberId: {
                            cardNo: cardValue,
                            name: String(row[2] || "").trim(),
                            idNumber: String(row[3] || "").trim(),
                            phone: String(row[4] || "").trim(),
                            expireDate: excelDateToJSDate(row[5]), // Converts 46447.000... to YYYY-MM-DD
                            barcode_number: cardValue,
                            // Default values to match your required structure
                            gender: "male",
                            status: "verified",
                            nationality: "local",
                            isUnbanned: false
                        }
                    };
                });

                console.log("ðŸŸ¢ðŸŸ¢ðŸŸ¢ Loaded Database Data:", databaseData);
                document.getElementById('excelStatus').innerText = `âœ… Loaded ${databaseData.length} cards.`;

                // IMPORTANT: Call renderHTML here so the canvases exist before PPTX generation
                renderHTML();
            };
            reader.readAsArrayBuffer(file);
        }

        // Helper to handle Excel's serial date format
        function excelDateToJSDate(serial) {
            if (!serial || isNaN(serial)) return String(serial || "");
            const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
            return date.toISOString().split('T')[0]; // Returns "2027-03-01"
        }

        // 2. Modified renderHTML to handle errors
        function renderHTML() {
            const container = document.getElementById('card-container');
            container.innerHTML = '';

            if (databaseData.length === 0) return;

            databaseData.forEach(user => {
                const cardNo = user.memberId.cardNo;
                // Robust SafeID for Barcode
                const safeId = cardNo.replace(/[^a-z0-9]/gi, '_');
                // TODO:: const safeId = user.memberId.barcode_number.replace(/[^a-z0-9]/gi, '_');

                let hasImage = profileMap[cardNo] || profileMap[cardNo.replace(/\s/g, '')];
                let statusHTML = hasImage
                    ? `<span style="color:green; font-weight:bold; font-size:12px;">Image Ready</span>`
                    : `<span style="color:red; font-size:12px;">No Image Found</span>`;

                const cardHTML = `
            <div class="card" style="border: 1px solid #ccc; margin: 10px; padding: 10px; display: inline-block; width: 350px;">
                <div class="photo-box" style="width:100px; height:100px; border:1px solid #eee; display:flex; align-items:center; justify-content:center;">
                    ${statusHTML}   
                </div>
                <div class="barcode-box">
                    <canvas id="bc-${safeId}"></canvas>
                </div>
                <div class="info-box">
                    <div><b>Name:</b> ${user.memberId.name}</div>
                    <div><b>ID:</b> ${user.memberId.idNumber}</div>
                    <div><b>Exp:</b> ${user.memberId.expireDate}</div>
                </div>
            </div>`;
                container.insertAdjacentHTML('beforeend', cardHTML);

                // Generate barcode
                JsBarcode(`#bc-${safeId}`, user.memberId.barcode_number, {
                    format: "CODE128",
                    lineColor: "#000",
                    width: 2,
                    height: 55,
                    displayValue: true,
                    fontSize: 12,
                    fontOptions: "bold",
                    textMargin: 2,
                    background: "rgba(255,255,255,0.8)"
                });
            });
        }
        /// ------------ |
        const container = document.getElementById('card-container');

        // Initial render
        renderHTML();
        // ==========================================
        // OPTIMIZED PPTX GENERATION (Using Slide Masters)
        // ==========================================
        async function generatePPTXOptimized() {
            if (!backgroundBase64) {
                alert("Please select your background image first!");
                return;
            }

            let pres = new PptxGenJS();

            // 1. Setup A4 Page (Portrait)
            pres.defineLayout({ name: 'A4', width: 8.27, height: 11.69 });
            pres.layout = 'A4';

            // 2. DEFINE SLIDE MASTER
            // This embeds the background image ONLY ONCE in the file structure
            pres.defineSlideMaster({
                title: "ID_CARD_MASTER",
                background: { data: backgroundBase64 } // Sets image as background
            });

            // Grid Configuration (Inches)
            const startX_Left = 0.2;
            const startX_Right = 4.2;
            const startY = 0.2;
            const cardHeight = 2.92;

            let textOpts = { fontSize: 10.5, fontFace: "Calibri (Body)", color: "000000" };

            // 1. DEFINE CUSTOM OFFSET (Change this number to move it lower)
            const cardNoOffsetY = 0.25;

            let cardTextOpts = {
                fontSize: 10.5, fontFace: "Calibri (Body)", color: "000000",
                align: "center",
                valign: "top"
            };

            let currentSlide = null;

            for (let i = 0; i < databaseData.length; i++) {
                let user = databaseData[i];
                let cardNo = user.memberId.cardNo;

                const expireDate = new Date(user.memberId.expireDate).toLocaleDateString('en-GB');

                // --- NEW SLIDE LOGIC ---
                // Create new slide every 8th record
                if (i % 8 === 0) {
                    // Use the Master we defined above
                    currentSlide = pres.addSlide({ masterName: "ID_CARD_MASTER" });
                }

                // --- COORDINATE CALCULATIONS ---
                let localIndex = i % 8;
                let col = localIndex % 2;
                let row = Math.floor(localIndex / 2);

                let cardX = (col === 0) ? startX_Left : startX_Right;
                let cardY = startY + (row * cardHeight);


                // 1. PROFILE IMAGE
                // Check if we have an image for this card
                let profileImgSrc = profileMap[cardNo] || profileMap[cardNo.replace(/\s/g, '')];

                if (profileImgSrc) {
                    // Adjust offset based on column
                    // Left Col Photo X: approx 0.35 from card edge
                    // Right Col Photo X: approx 0.20 from card edge (as per your template symmetry issues)
                    // let photoOffsetX = (col === 0) ? 0.3 : 0.15;
                    let photoOffsetX = (col === 0) ? 0.08 : 0.03;

                    currentSlide.addImage({
                        data: profileImgSrc,
                        x: cardX + photoOffsetX,
                        y: cardY + 0.45, // Vertical pos of white box
                        w: 1.03, // Width of white box approx
                        h: 1.05, // Height of white box approx
                        sizing: { type: "contain" } // Ensure image fits in box
                    });
                }

                // --- BARCODE ---
                // const safeId = user["memberId"]["barcode_number"].replace(/\s/g, '');
                const safeId = user.memberId.cardNo.replace(/[^a-z0-9]/gi, '_'); // Match the new logic
                console.log(`ðŸŸ¢ðŸŸ¢ðŸŸ¢ Generating barcode for: ${safeId}`,);

                // NEW: Extract PNG data from Canvas
                const canvasNode = document.getElementById(`bc-${safeId}`);
                if (!canvasNode) {
                    console.warn(`Missing canvas for ${safeId}`);
                    continue; // Skip this card if canvas wasn't found to avoid crash
                }
                const fullBase64 = canvasNode.toDataURL("image/png");


                // const svgNode = document.getElementById(`bc-${safeId}`);
                // const xml = new XMLSerializer().serializeToString(svgNode);
                // const image64 = btoa(unescape(encodeURIComponent(xml)));
                // const fullBase64 = 'data:image/svg+xml;base64,' + image64;

                let bcOffsetX = (col === 0) ? 1.45 : 1.34;

                // Barcode Image Dimensions
                let bcW = 1.4;
                let bcH = 0.4;
                let bcX = cardX + bcOffsetX - 0.18;
                let bcY = cardY + 0.68;

                currentSlide.addImage({
                    data: fullBase64,
                    x: bcX,
                    y: bcY,
                    w: 1.4,
                    h: 0.4
                });

                // --- CARD NO CENTERED UNDER BARCODE ---
                currentSlide.addText(user["memberId"]["cardNo"], {
                    x: bcX,
                    //  APPLY OFFSET (Barcode Y + Barcode Height + Your Custom Space)
                    y: bcY + bcH + cardNoOffsetY,
                    w: bcW,
                    h: 0.25,
                    ...cardTextOpts,
                });

                // --- TEXT ---
                let labelW = 1.5;
                let valW = 2.0;
                let textStartX = cardX + 0.1;
                let textStartY = cardY + 1.9 - cardNoOffsetY;
                let lineH = 0.25;


                // Name
                currentSlide.addText("á€¡á€™á€Šá€º", { x: textStartX, y: textStartY, w: labelW, h: 0.3, ...textOpts });
                currentSlide.addText(`- ${user["memberId"]["name"]}`, { x: textStartX + labelW, y: textStartY, w: valW, h: 0.3, ...textOpts });

                // NRC
                currentSlide.addText("á€™á€¾á€á€ºá€•á€¯á€¶á€á€„á€ºá€¡á€™á€¾á€á€º", { x: textStartX, y: textStartY + lineH, w: labelW, h: 0.3, ...textOpts });
                currentSlide.addText(`- ${user["memberId"]["idNumber"]}`, { x: textStartX + labelW, y: textStartY + lineH, w: valW, h: 0.3, ...textOpts });

                // Expiry
                currentSlide.addText("á€žá€€á€ºá€á€™á€ºá€¸á€€á€¯á€”á€ºá€†á€¯á€¶á€¸á€›á€€á€º", { x: textStartX, y: textStartY + (lineH * 2), w: labelW, h: 0.3, ...textOpts });
                currentSlide.addText(`- ${user["memberId"]["expireDate"].slice(0, 10)}`, { x: textStartX + labelW, y: textStartY + (lineH * 2), w: valW, h: 0.3, ...textOpts });
            }

            pres.writeFile({ fileName: `${databaseData[0].memberId.cardNo}_To_${databaseData[databaseData.length - 1].memberId.cardNo}_Total_${databaseData.length}_Cards.pptx` });
        }

    </script>
</body>

</html>