<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Myanmar ID Card Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        body {
            font-family: 'Padauk', sans-serif;
            background-color: #555;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 210mm;
            box-sizing: border-box;
        }

        .btn-group {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        button {
            background-color: #d24726;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            background-color: #b03a1e;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        input[type="file"] {
            margin-bottom: 10px;
        }

        /* A4 Page Container */
        .page {
            width: 210mm;
            height: 297mm;
            background-color: white;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr);
            padding: 2mm;
            grid-gap: 2mm;
            box-sizing: border-box;

            /* Background settings */
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }

        .card {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Barcode Area */
        .barcode-box {
            position: absolute;
            top: 29.5%;
            width: 35%;
            text-align: center;
        }

        .barcode-box svg {
            width: 90%;
            height: auto;
        }

        /* Text Info Area */
        .info-box {
            position: absolute;
            top: 65%;
            left: 5%;
            width: 90%;
            font-size: 16px;
            font-weight: bold;
            line-height: 1.9;
            color: #000;
        }

        /* CSS Grid Adjustments */
        .card:nth-child(odd) .barcode-box {
            left: 34%;
            top: 29.5%;
        }

        .card:nth-child(even) .barcode-box {
            left: 30.5%;
            top: 29.5%;
        }

        .card:nth-child(even) .info-box {
            left: 1%;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
        }

        .label {
            width: 38%;
            color: #2e2e2e;
        }

        .val {
            width: 62%;
            padding-left: 5px;
        }

        /* Print Settings */
        @media print {
            body {
                background: none;
                padding: 0;
            }

            .page {
                width: 210mm;
                height: 297mm;
                box-shadow: none;
                margin: 0;
                -webkit-print-color-adjust: exact;
                /* Ensure background graphics print */
            }

            @page {
                margin: 0;
                size: A4;
            }
        }
    </style>
</head>

<body>

    <div class="controls">
        <h3>Step 1: Load Background Image</h3>
        <input type="file" id="bgInput" accept="image/*" onchange="loadBackground(event)">

        <div class="btn-group">
            <h3>Step 2:</h3>
            <button id="dlBtn" onclick="generatePPTX()" disabled>Download as .pptx</button>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">* You must load the background image first.</p>
    </div>

    <div class="page" id="card-container">
    </div>

    <script>
        // Global variable to store the background image data
        let backgroundBase64 = null;

        // Function to handle Image Upload
        function loadBackground(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    backgroundBase64 = e.target.result;

                    // 1. Update the HTML preview
                    document.getElementById('card-container').style.backgroundImage = `url('${backgroundBase64}')`;

                    // 2. Enable the download button
                    document.getElementById('dlBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // Data Source
        const databaseData = [
            { barcode: "A - 01601", name: "ဦးမျိုးမင်း", nrc: "၅/ပလန(နိုင်)၀၉၃၈၇၇", exp: "၁၂/၁၁/၂၀၂၆" },
            { barcode: "A - 01602", name: "ဦးအောင်မောင်လေး", nrc: "၉/မဆန(နိုင်)၀၁၇၅၉၄", exp: "၁၂/၁၁/၂၀၂၆" },
            { barcode: "A - 01603", name: "ဦးဟန်ထွန်း", nrc: "၈/ပခက(နိုင်)၁၉၇၆၆၆", exp: "၁၂/၁၁/၂၀၂၆" },
            { barcode: "A - 01604", name: "ဦးနေနော်စိုး", nrc: "၅/ဝလန(နိုင်)၁၈၀၀၁၇", exp: "၁၂/၁၁/၂၀၂၆" },
            { barcode: "A - 01605", name: "ဦးအောင်ရဲကျော်", nrc: "၉/ခအဇ(နိုင်)၀၃၉၉၁၄", exp: "၁၂/၁၁/၂၀၂၆" },
            { barcode: "A - 01606", name: "ဦးဟိန်းဝဏ္ဏအောင်", nrc: "၉/မဟမ(နိုင်)၀၅၇၂၇၂", exp: "၁၂/၁၁/၂၀၂၆" },
            { barcode: "A - 01607", name: "ဦးရဲနိုင်", nrc: "၅/ဝလန(နိုင်)၁၆၃၁၂၄", exp: "၁၂/၁၁/၂၀၂၆" },
            { barcode: "A - 01608", name: "ဦးအောင်မင်းခန့်", nrc: "၅/မကန(နိုင်)၃၀၈၆၈၀", exp: "၁၂/၁၁/၂၀၂၆" },
        ];

        const container = document.getElementById('card-container');

        // HTML Generation for Preview
        function createCard(user) {
            const safeId = user.barcode.replace(/\s/g, '');
            return `
                <div class="card">
                    <div class="barcode-box">
                        <svg id="bc-${safeId}"></svg>
                    </div>
                    <div class="info-box">
                        <div class="info-row">
                            <div class="label">အမည်</div>
                            <div class="val">- ${user.name}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">မှတ်ပုံတင်အမှတ်</div>
                            <div class="val">- ${user.nrc}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">သက်တမ်းကုန်ဆုံးရက်</div>
                            <div class="val">- ${user.exp}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        databaseData.forEach(user => {
            container.innerHTML += createCard(user);
        });

        databaseData.forEach(user => {
            const safeId = user.barcode.replace(/\s/g, '');
            JsBarcode(`#bc-${safeId}`, user.barcode, {
                format: "CODE128",
                lineColor: "#000",
                width: 2,
                height: 55,
                displayValue: true,
                fontSize: 12,
                fontOptions: "bold",
                textMargin: 2,
                background: "rgba(255,255,255,0.8)"
            });
        });

        // ==========================================
        // PPTX GENERATION LOGIC
        // ==========================================
        async function generatePPTX() {
            if (!backgroundBase64) {
                alert("Please select your background image first!");
                return;
            }

            let pres = new PptxGenJS();

            // 1. Setup A4 Page (Portrait)
            pres.defineLayout({ name: 'A4', width: 8.27, height: 11.69 });
            pres.layout = 'A4';

            // 2. Add Slide
            let slide = pres.addSlide();

            // 3. Add Background Image (Using the loaded Base64 string)
            slide.addImage({ data: backgroundBase64, x: 0, y: 0, w: "100%", h: "100%" });

            // Grid Configuration (Inches)
            const startX_Left = 0.2;
            const startX_Right = 4.2;
            const startY = 0.2;
            const cardHeight = 2.92;

            // Use standard system font or Padauk if installed on system
            // Note: PPTXGenJS can't embed web fonts easily, it relies on system fonts.
            let textOpts = { fontSize: 10, fontFace: "CaCalibri (Body)", bold: true, color: "000000" };

            for (let i = 0; i < databaseData.length; i++) {
                let user = databaseData[i];

                let col = i % 2;
                let row = Math.floor(i / 2);

                let cardX = (col === 0) ? startX_Left : startX_Right;
                let cardY = startY + (row * cardHeight);

                // --- BARCODE ---
                const safeId = user.barcode.replace(/\s/g, '');
                const svgNode = document.getElementById(`bc-${safeId}`);
                const xml = new XMLSerializer().serializeToString(svgNode);
                // Convert SVG XML to Base64 Data URI
                const image64 = btoa(unescape(encodeURIComponent(xml)));
                const fullBase64 = 'data:image/svg+xml;base64,' + image64;

                let bcOffsetX = (col === 0) ? 1.4 : 1.25;

                slide.addImage({
                    data: fullBase64,
                    x: cardX + bcOffsetX - 0.18,
                    y: cardY + 0.85 - 0.18,
                    w: 1.4,
                    h: 0.4
                });

                // --- TEXT ---
                let labelW = 1.5;
                let valW = 2.0;
                let textStartX = cardX + 0.1;
                let textStartY = cardY + 1.9;
                let lineH = 0.25;

                // Name
                slide.addText("အမည်", { x: textStartX, y: textStartY, w: labelW, h: 0.3, ...textOpts });
                slide.addText(`- ${user.name}`, { x: textStartX + labelW, y: textStartY, w: valW, h: 0.3, ...textOpts });

                // NRC
                slide.addText("မှတ်ပုံတင်အမှတ်", { x: textStartX, y: textStartY + lineH, w: labelW, h: 0.3, ...textOpts });
                slide.addText(`- ${user.nrc}`, { x: textStartX + labelW, y: textStartY + lineH, w: valW, h: 0.3, ...textOpts });

                // Expiry
                slide.addText("သက်တမ်းကုန်ဆုံးရက်", { x: textStartX, y: textStartY + (lineH * 2), w: labelW, h: 0.3, ...textOpts });
                slide.addText(`- ${user.exp}`, { x: textStartX + labelW, y: textStartY + (lineH * 2), w: valW, h: 0.3, ...textOpts });
            }

            pres.writeFile({ fileName: "Myanmar_ID_Cards.pptx" });
        }
    </script>
</body>

</html>